services:
  # PostgreSQL Database
  - type: pserv
    name: skincare-postgres
    plan: free
    env: docker
    dockerfilePath: ./Dockerfile.postgres
    envVars:
      - key: POSTGRES_USER
        value: airflow
      - key: POSTGRES_PASSWORD
        generateValue: true
      - key: POSTGRES_DB
        value: airflow

  # Flask App
  - type: web
    name: skincare-flask
    plan: free
    env: docker
    dockerfilePath: ./webapp/Dockerfile
    dockerContext: ./webapp
    envVars:
      - key: FLASK_ENV
        value: production
      - key: FLASK_SECRET_KEY
        generateValue: true
      - key: DATABASE_URL
        fromDatabase:
          name: skincare-postgres
          property: connectionString
      - key: AIRFLOW_URL
        value: http://skincare-airflow:10000
      - key: AIRFLOW_USER
        value: admin
      - key: AIRFLOW_PASSWORD
        value: admin
      - key: DEEPSEEK_API_KEY
        sync: false
    disk:
      name: flask-data
      mountPath: /app/data
      sizeGB: 1

  # Airflow Webserver
  - type: web
    name: skincare-airflow-webserver
    plan: free
    env: docker
    dockerfilePath: ./Dockerfile.airflow
    dockerCommand: |
      airflow db migrate &&
      airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com || true &&
      airflow webserver
    envVars:
      - key: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
        fromDatabase:
          name: skincare-postgres
          property: connectionString
      - key: AIRFLOW__API__AUTH_BACKENDS
        value: airflow.api.auth.backend.basic_auth
    disk:
      name: airflow-data
      mountPath: /opt/airflow/data
      sizeGB: 1

  # Airflow Scheduler
  - type: worker
    name: skincare-airflow-scheduler
    plan: free
    env: docker
    dockerfilePath: ./Dockerfile.airflow
    dockerCommand: airflow scheduler
    envVars:
      - key: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
        fromDatabase:
          name: skincare-postgres
          property: connectionString
    disk:
      name: airflow-data
      mountPath: /opt/airflow/data
      sizeGB: 1

databases:
  - name: skincare-postgres
    databaseName: airflow
    user: airflow
    plan: free